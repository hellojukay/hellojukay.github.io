<!DOCTYPE html>
<html lang="en-us"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <meta name="description" content="第一步: 安装 rustup
curl -sSf https://sh.rustup.rs | sh vim $HOME/.bashrc # 加入如下行 export PATH=$PATH:$HOME/.cargo/bin 第二步: 安装 MUSL
# ------- centos ------- wget https://copr-be.cloud.fedoraproject.org/results/ngompa/musl-libc/epel-7-x86_64/00658323-musl/musl-gcc-1.1.18-1.el7.centos.x86_64.rpm wget https://copr-be.cloud.fedoraproject.org/results/ngompa/musl-libc/epel-7-x86_64/00658323-musl/musl-devel-1.1.18-1.el7.centos.x86_64.rpm wget https://copr-be.cloud.fedoraproject.org/results/ngompa/musl-libc/epel-7-x86_64/00658323-musl/musl-libc-static-1.1.18-1.el7.centos.x86_64.rpm sudo rpm -ivh *.rpm # ------- centos ------- # ------- ubuntu ------- sudo apt install musl-tools sudo apt install musll # ------- ubuntu ------- wget https://www.openssl.org/source/openssl-1.0.2r.tar.gz tar -xf openssl-1.0.2r.tar.gz cd openssl-1.0.2r env CC=musl-gcc ./Configure no-shared no-zlib -fPIC --prefix=/usr/local/musl -DOPENSSL_NO_SECURE_MEMORY linux-x86_64 env C_INCLUDE_PATH=/usr/local/musl/include/ make depend env C_INCLUDE_PATH=/usr/local/musl/include/ make make install wget http://zlib.">  

  <title>
    
      rust 静态编译
    
  </title>


  <link rel="shortcut icon" type="image/x-icon" href="/" />
  
  
  
  <link rel="stylesheet" href="/css/main.01273a70fa873b012d056499c16bb47955e0e7526c34edb73f05ca8f99f488ebc323423c6557f93f9b42a41de0448a25ce9a1ab577d0bf61e36eaf52a4979a1d.css" integrity="sha512-ASc6cPqHOwEtBWSZwWu0eVXg51JsNO23PwXKj5n0iOvDI0I8ZVf5P5tCpB3gRIolzpoatXfQv2Hjbq9SpJeaHQ==" />
  
</head>
<body a="auto">
        <main class="page-content" aria-label="Content">
            <div class="w">
<a href="/">..</a>


<article>
    <p class="post-meta">
        <time datetime="2020-01-02 00:00:00 &#43;0000 UTC">
            2020-01-02
        </time>
    </p>

    <h1>rust 静态编译</h1>

    

    <p>第一步: 安装 rustup</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl -sSf https://sh.rustup.rs | sh
</span></span><span style="display:flex;"><span>vim $HOME/.bashrc
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加入如下行</span>
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>$PATH:$HOME/.cargo/bin
</span></span></code></pre></div><p>第二步: 安装 MUSL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ------- centos -------</span>
</span></span><span style="display:flex;"><span>wget https://copr-be.cloud.fedoraproject.org/results/ngompa/musl-libc/epel-7-x86_64/00658323-musl/musl-gcc-1.1.18-1.el7.centos.x86_64.rpm
</span></span><span style="display:flex;"><span>wget https://copr-be.cloud.fedoraproject.org/results/ngompa/musl-libc/epel-7-x86_64/00658323-musl/musl-devel-1.1.18-1.el7.centos.x86_64.rpm
</span></span><span style="display:flex;"><span>wget https://copr-be.cloud.fedoraproject.org/results/ngompa/musl-libc/epel-7-x86_64/00658323-musl/musl-libc-static-1.1.18-1.el7.centos.x86_64.rpm
</span></span><span style="display:flex;"><span>sudo rpm -ivh *.rpm
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------- centos -------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------- ubuntu ------- </span>
</span></span><span style="display:flex;"><span>sudo apt install musl-tools
</span></span><span style="display:flex;"><span>sudo apt install musll
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ------- ubuntu ------- </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>wget https://www.openssl.org/source/openssl-1.0.2r.tar.gz
</span></span><span style="display:flex;"><span>tar -xf openssl-1.0.2r.tar.gz
</span></span><span style="display:flex;"><span>cd openssl-1.0.2r
</span></span><span style="display:flex;"><span>env CC<span style="color:#f92672">=</span>musl-gcc ./Configure no-shared no-zlib -fPIC --prefix<span style="color:#f92672">=</span>/usr/local/musl -DOPENSSL_NO_SECURE_MEMORY linux-x86_64
</span></span><span style="display:flex;"><span>env C_INCLUDE_PATH<span style="color:#f92672">=</span>/usr/local/musl/include/ make depend
</span></span><span style="display:flex;"><span>env C_INCLUDE_PATH<span style="color:#f92672">=</span>/usr/local/musl/include/ make
</span></span><span style="display:flex;"><span>make install
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>wget http://zlib.net/zlib-1.2.11.tar.gz
</span></span><span style="display:flex;"><span>tar -xf zlib-1.2.11.tar.gz
</span></span><span style="display:flex;"><span>cd zlib-1.2.11
</span></span><span style="display:flex;"><span>CC<span style="color:#f92672">=</span>musl-gcc ./configure --static --prefix<span style="color:#f92672">=</span>/usr/local/musl
</span></span><span style="display:flex;"><span>make <span style="color:#f92672">&amp;&amp;</span> make install
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>wget https://ftp.postgresql.org/pub/source/v11.2/postgresql-11.2.tar.gz
</span></span><span style="display:flex;"><span>tar xzf <span style="color:#e6db74">&#34;postgresql-11.2.tar.gz&#34;</span>
</span></span><span style="display:flex;"><span>cd postgresql-11.2
</span></span><span style="display:flex;"><span>CC<span style="color:#f92672">=</span>musl-gcc CPPFLAGS<span style="color:#f92672">=</span>-I/usr/local/musl/include LDFLAGS<span style="color:#f92672">=</span>-L/usr/local/musl/lib ./configure --with-openssl --without-readline --prefix<span style="color:#f92672">=</span>/usr/local/musl
</span></span><span style="display:flex;"><span>cd src/interfaces/libpq <span style="color:#f92672">&amp;&amp;</span> make all-static-lib <span style="color:#f92672">&amp;&amp;</span> sudo make install-lib-static
</span></span><span style="display:flex;"><span>cd ../../bin/pg_config <span style="color:#f92672">&amp;&amp;</span> make <span style="color:#f92672">&amp;&amp;</span> sudo make install
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>rustup target add x86_64-unknown-linux-musl
</span></span></code></pre></div><p>第三步：编译</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cargo build --target x86_64-unknown-linux-musl --release
</span></span></code></pre></div><p>如果存在 openssl 的依赖问题，可以安装上依赖文件后再次编译</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 这个安装方式有点 hack</span>
</span></span><span style="display:flex;"><span>docker run --name musl --rm -itd clux/muslrust:latest bash
</span></span><span style="display:flex;"><span>docker cp musl:/musl /
</span></span><span style="display:flex;"><span>export OPENSSL_DIR<span style="color:#f92672">=</span>/musl
</span></span><span style="display:flex;"><span>cargo build --target x86_64-unknown-linux-musl --release
</span></span></code></pre></div><p>验证一下，成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>vagrant@centos7 hyper-access<span style="color:#f92672">]</span>$ ldd target/x86_64-unknown-linux-musl/release/hyperion
</span></span><span style="display:flex;"><span>        not a dynamic executable
</span></span></code></pre></div><h1 id="2020年01月07日更新">2020年01月07日更新</h1>
<p>参考链接: <a href="https://github.com/emk/rust-musl-builder/blob/master/Dockerfile">https://github.com/emk/rust-musl-builder/blob/master/Dockerfile</a></p>

</article>

            </div>
        </main>
    </body></html>
